



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Getting Started - Formula</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.0284f74d.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../css/app.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#getting-started" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Formula" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Formula
            </span>
            <span class="md-header-nav__topic">
              
                Getting Started
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/instacart/formula/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Formula
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Formula" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Formula
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/instacart/formula/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Formula
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../input/" title="Using Input" class="md-nav__link">
      Using Input
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../messages/" title="Messages" class="md-nav__link">
      Messages
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../composition/" title="Composition" class="md-nav__link">
      Composition
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../testing/" title="Testing" class="md-nav__link">
      Testing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Integration/" title="Formula Android" class="md-nav__link">
      Formula Android
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../using_android_view_model/" title="Using Android View Model" class="md-nav__link">
      Using Android View Model
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../faq/" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contributing/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#core-concepts" title="Core concepts" class="md-nav__link">
    Core concepts
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#state" title="State" class="md-nav__link">
    State
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#render-model" title="Render Model" class="md-nav__link">
    Render Model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#render-view" title="Render View" class="md-nav__link">
    Render View
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#render-model-generator" title="Render Model Generator" class="md-nav__link">
    Render Model Generator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reducers" title="Reducers" class="md-nav__link">
    Reducers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#render-formula" title="Render Formula" class="md-nav__link">
    Render Formula
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-render-formula" title="Using Render Formula" class="md-nav__link">
    Using Render Formula
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-render-formula-with-android-view-model" title="Using Render Formula with Android View Model" class="md-nav__link">
    Using Render Formula with Android View Model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#input" title="Input" class="md-nav__link">
    Input
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#effects" title="Effects" class="md-nav__link">
    Effects
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handling-user-ui-actions" title="Handling User UI Actions" class="md-nav__link">
    Handling User UI Actions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handling-user-action-internally" title="Handling User Action Internally" class="md-nav__link">
    Handling User Action Internally
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#composing-render-models" title="Composing Render models" class="md-nav__link">
    Composing Render models
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#annotation-processor" title="Annotation processor" class="md-nav__link">
    Annotation processor
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-exportedproperty" title="Using @ExportedProperty" class="md-nav__link">
    Using @ExportedProperty
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-isdirectinput-exportedproperty" title="Using isDirectInput (@ExportedProperty)" class="md-nav__link">
    Using isDirectInput (@ExportedProperty)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-directinput" title="Using @DirectInput" class="md-nav__link">
    Using @DirectInput
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#navigation" title="Navigation" class="md-nav__link">
    Navigation
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/instacart/formula/edit/master/docs/Old-Getting-Started.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="getting-started">Getting Started</h1>
<p>A functional reactive framework for managing state and side effects based on RxJava. It enables building 
deterministic, composable, testable applications.</p>
<h2 id="core-concepts">Core concepts</h2>
<h3 id="state">State</h3>
<p>State is a Kotlin data class that contains all the necessary information to render your view. </p>
<div class="codehilite"><pre><span></span><span class="k">data</span> <span class="k">class</span> <span class="nc">MyScreenState</span><span class="p">(</span>
  <span class="k">val</span> <span class="py">userInfoRequest</span><span class="p">:</span> <span class="n">Lce</span><span class="p">&lt;</span><span class="n">UserInfo</span><span class="p">&gt;,</span>
  <span class="k">val</span> <span class="py">isSaving</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span>
<span class="p">)</span>
</pre></div>


<p>Note: for info about <code>Lce</code>, please check <a href="https://tech.instacart.com/lce-modeling-data-loading-in-rxjava-b798ac98d80">this article</a>.  </p>
<h3 id="render-model">Render Model</h3>
<p>Render Model is an immutable representation of your view. It will be used to update the Android views. Typically,
it will also contain callbacks that will be invoked when user interacts with the UI.</p>
<div class="codehilite"><pre><span></span><span class="k">data</span> <span class="k">class</span> <span class="nc">FooterButtonRenderModel</span><span class="p">(</span>
  <span class="k">val</span> <span class="py">title</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
  <span class="k">val</span> <span class="py">isEnabled</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
  <span class="k">val</span> <span class="py">onClick</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
<span class="p">)</span>
</pre></div>


<h3 id="render-view">Render View</h3>
<p>Render view is responsible for taking the Render Model and applying it to the Android views.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">FooterButtonRenderView</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">root</span><span class="p">:</span> <span class="n">View</span><span class="p">)</span> <span class="p">:</span> <span class="n">RenderView</span><span class="p">&lt;</span><span class="n">FooterButtonRenderModel</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">footerButton</span><span class="p">:</span> <span class="n">Button</span> <span class="p">=</span> <span class="n">root</span><span class="p">.</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">footer_button</span><span class="p">)</span>

  <span class="k">override</span> <span class="k">val</span> <span class="py">renderer</span><span class="p">:</span> <span class="n">Renderer</span><span class="p">&lt;</span><span class="n">FooterButtonRenderModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">Renderer</span><span class="p">.</span><span class="n">create</span> <span class="p">{</span> <span class="n">model</span> <span class="p">-&gt;</span>
    <span class="n">footerButton</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">title</span>
    <span class="n">footerButton</span><span class="p">.</span><span class="n">isEnabled</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">isEnabled</span>
    <span class="n">footerButton</span><span class="p">.</span><span class="n">setOnClickListener</span> <span class="p">{</span>
      <span class="n">model</span><span class="p">.</span><span class="n">onClick</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span> 
<span class="p">}</span>
</pre></div>


<h3 id="render-model-generator">Render Model Generator</h3>
<p>Render Model Generator takes a State and creates a Render Model from it. </p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyScreenRenderModelGenerator</span><span class="p">(</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">onSaveUserInfoSelected</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">RenderModelGenerator</span><span class="p">&lt;</span><span class="n">MyScreenState</span><span class="p">,</span> <span class="n">FooterButtonRenderModel</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">toRenderModel</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">MyScreenState</span><span class="p">):</span> <span class="n">FooterButtonRenderModel</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">FooterButtonRenderModel</span><span class="p">(</span>
      <span class="n">title</span> <span class="p">=</span> <span class="s">&quot;Save User Info&quot;</span><span class="p">,</span>
      <span class="n">isEnabled</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="n">userInfoRequest</span><span class="p">.</span><span class="n">isData</span><span class="p">()</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">state</span><span class="p">.</span><span class="n">isSaving</span><span class="p">,</span>
      <span class="n">onClick</span> <span class="p">=</span> <span class="n">onSaveUserInfoSelected</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3 id="reducers">Reducers</h3>
<p>Reducers class defines all the possible State transformations. It defines methods that take an event object and 
return a transformation. Instead of of mutating properties when an event happens, we create a new version of the
State class. To accomplish that, we use data class <code>copy</code> method.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyScreenReducers</span> <span class="p">:</span> <span class="n">Reducers</span><span class="p">&lt;</span><span class="n">MyScreenState</span><span class="p">,</span> <span class="n">Unit</span><span class="p">&gt;()</span> <span class="p">{</span>

  <span class="k">fun</span> <span class="nf">onUserInfoRequest</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Lce</span><span class="p">&lt;</span><span class="n">UserInfo</span><span class="p">&gt;)</span> <span class="p">=</span> <span class="n">withoutEffects</span> <span class="p">{</span> <span class="n">state</span> <span class="p">-&gt;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">userInfoRequest</span> <span class="p">=</span> <span class="n">event</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">fun</span> <span class="nf">onSaveUserInfoRequest</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Lce</span><span class="p">&lt;</span><span class="n">SaveUserInfoResponse</span><span class="p">&gt;)</span> <span class="p">=</span> <span class="n">withoutEffects</span> <span class="p">{</span> <span class="n">state</span> <span class="p">-&gt;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isSaving</span> <span class="p">=</span> <span class="n">event</span><span class="p">.</span><span class="n">isLoading</span><span class="p">())</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3 id="render-formula">Render Formula</h3>
<p>Render Formula is responsible for state management. It combines various RxJava event streams and maps them to 
state transformations.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyScreenRenderFormula</span><span class="p">(</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">userRepo</span><span class="p">:</span> <span class="n">UserRepo</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">RenderFormula</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">,</span> <span class="n">MyScreenState</span><span class="p">,</span> <span class="n">FooterButtonRenderModel</span><span class="p">,</span> <span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">createRenderLoop</span><span class="p">(</span><span class="n">input</span><span class="p">:</span> <span class="n">Unit</span><span class="p">):</span> <span class="n">RenderLoop</span><span class="p">&lt;</span><span class="n">MyScreenState</span><span class="p">,</span> <span class="n">Unit</span><span class="p">,</span> <span class="n">FooterButtonRenderModel</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">reducers</span> <span class="p">=</span> <span class="n">MyScreenReducers</span><span class="p">()</span>

    <span class="k">val</span> <span class="py">userInfoRequestChanges</span> <span class="p">=</span> <span class="n">userRepo</span><span class="p">.</span><span class="n">fetchUserInfo</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="n">reducers</span><span class="o">::</span><span class="n">onUserInfoRequest</span><span class="p">)</span>

    <span class="c1">// We use a RxRelay library to turn user events into an RxJava stream</span>
    <span class="k">val</span> <span class="py">saveUserInfoRelay</span> <span class="p">=</span> <span class="n">PublishRelay</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;()</span>
    <span class="k">val</span> <span class="py">saveUserInfoChanges</span> <span class="p">=</span> <span class="n">saveUserInfoRelay</span>
      <span class="p">.</span><span class="n">switchMap</span> <span class="p">{</span> <span class="n">userRepo</span><span class="p">.</span><span class="n">saveUserInfo</span><span class="p">()</span> <span class="p">}</span>
      <span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">reducers</span><span class="o">::</span><span class="n">onSaveUserInfoRequest</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">RenderLoop</span><span class="p">(</span>
      <span class="n">initialState</span> <span class="p">=</span> <span class="n">MyScreenState</span><span class="p">(</span>
        <span class="n">userInfoRequest</span> <span class="p">=</span> <span class="n">Lce</span><span class="p">.</span><span class="n">loading</span><span class="p">()</span>
      <span class="p">),</span>
      <span class="n">reducers</span> <span class="p">=</span> <span class="n">Observable</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">userInfoRequestChanges</span><span class="p">,</span>
        <span class="n">saveUserInfoChanges</span>
      <span class="p">),</span>
      <span class="n">renderModelGenerator</span> <span class="p">=</span> <span class="n">MyScreeenRenderModelGenerator</span><span class="p">(</span>
        <span class="n">onSaveUserInfoSelected</span> <span class="p">=</span> <span class="p">{</span>
          <span class="n">saveUserInfoRelay</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">)</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3 id="using-render-formula">Using Render Formula</h3>
<p>Render formula is agnostic to other layers of abstraction. It can be used within activity or a fragment. Ideally, 
it would be placed within a surface that survives configuration changes such as Android Components ViewModel.</p>
<p>In this example, I'll show how to connect RenderFormula using Formula Android module. Let's first define our Activity.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyActivity</span> <span class="p">:</span> <span class="n">FormulaAppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">lateinit</span> <span class="k">var</span> <span class="py">footerButtonRenderView</span><span class="p">:</span> <span class="n">FooterButtonRenderView</span>  

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">my_screen</span><span class="p">)</span>

    <span class="n">footerButtonRenderView</span> <span class="p">=</span> <span class="n">FooterButtonRenderView</span><span class="p">(</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">footer</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="k">fun</span> <span class="nf">render</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">FooterButtonRenderModel</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">footerButtonRenderView</span><span class="p">.</span><span class="n">renderer</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Now, let's connect<code>MyScreenRenderFormula</code> to <code>MyActivity.render</code> function.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyApp</span> <span class="p">:</span> <span class="n">Application</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">()</span>

        <span class="n">FormulaAndroid</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">activity</span><span class="p">&lt;</span><span class="n">MyActivity</span><span class="p">&gt;</span> <span class="p">{</span>
                <span class="n">store</span><span class="p">(</span>
                    <span class="n">streams</span> <span class="p">=</span> <span class="p">{</span>
                        <span class="k">val</span> <span class="py">formula</span><span class="p">:</span> <span class="n">MyScreenRenderFormula</span> <span class="p">=</span> <span class="p">...</span> 
                        <span class="n">update</span><span class="p">(</span><span class="n">formula</span><span class="p">.</span><span class="n">state</span><span class="p">(</span><span class="n">Unit</span><span class="p">),</span> <span class="n">MyActivity</span><span class="o">::</span><span class="n">render</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>And that's it. To learn more, see our <a href="../Integration/">Formula Android Guide</a>.</p>
<h3 id="using-render-formula-with-android-view-model">Using Render Formula with Android View Model</h3>
<p>Defining <code>ViewModel</code> which runs <code>Formula.state</code> stream until <code>onCleared</code> is called.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyViewModel</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">formula</span><span class="p">:</span> <span class="n">MyScreenRenderFormula</span><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">disposables</span> <span class="p">=</span> <span class="n">CompositeDisposable</span><span class="p">()</span>

  <span class="k">val</span> <span class="py">renderModels</span> <span class="p">=</span> <span class="n">formula</span><span class="p">.</span><span class="n">state</span><span class="p">(</span><span class="n">Unit</span><span class="p">).</span><span class="n">replay</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">apply</span> <span class="p">{</span>
    <span class="n">connect</span> <span class="p">{</span> <span class="n">disposables</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCleared</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCleared</span><span class="p">()</span>
    <span class="n">disposables</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>In our activity, we then subscribe to the Render Model changes and pass them to the Render View.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyActivity</span> <span class="p">:</span> <span class="n">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">disposables</span> <span class="p">=</span> <span class="n">CompositeDisposable</span><span class="p">()</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">my_screen</span><span class="p">)</span>

    <span class="k">val</span> <span class="py">renderView</span> <span class="p">=</span> <span class="n">FooterButtonRenderView</span><span class="p">(</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">activity_content</span><span class="p">))</span>
    <span class="k">val</span> <span class="py">viewModel</span> <span class="p">=</span> <span class="n">ViewModelProviders</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="k">get</span><span class="p">(</span><span class="n">MyViewModel</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>

    <span class="n">disposables</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">renderModels</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">renderView</span><span class="p">.</span><span class="n">renderer</span><span class="o">::</span><span class="n">render</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onDestroy</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">disposables</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onDestroy</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3 id="input">Input</h3>
<p>Input is used to pass information when creating a state stream. Typically it will contain data necessary to initialize the state streams,
and callbacks for events that the parent should be aware of. </p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ItemDetailRenderFormula</span><span class="p">()</span> <span class="p">:</span> <span class="n">RenderFormula</span><span class="p">&lt;</span><span class="n">Input</span><span class="p">,</span> <span class="p">...,</span> <span class="p">...,</span> <span class="p">...&gt;</span> <span class="p">{</span>

  <span class="k">class</span> <span class="nc">Input</span><span class="p">(</span>
    <span class="k">val</span> <span class="py">itemId</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
    <span class="k">val</span> <span class="py">onItemDeleted</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
  <span class="p">)</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">createRenderLoop</span><span class="p">(</span><span class="n">input</span><span class="p">:</span> <span class="n">Input</span><span class="p">):</span> <span class="n">RenderLoop</span><span class="p">&lt;...&gt;</span> <span class="p">{</span>
    <span class="c1">// We can use the input here to fetch the item from the repo.</span>
    <span class="c1">// We can also notify the parent when the item is deleted using input.onItemDeleted()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3 id="effects">Effects</h3>
<p>Effects are message objects used to request the execution of impure code. Operations such as firing a network request,
reading / writing to disk, navigation or updating global state are considered side-effects. Instead of performing those
operations within the Reducers class, we return the Effect object and let the caller execute the side effect.</p>
<p>Typically, we define all possible side-effects as a sealed Kotlin class.</p>
<div class="codehilite"><pre><span></span><span class="k">sealed</span> <span class="k">class</span> <span class="nc">MyScreenEffect</span> <span class="p">{</span>
  <span class="k">data</span> <span class="k">class</span> <span class="nc">ShowErrorModal</span><span class="p">(</span><span class="k">val</span> <span class="py">errorMessage</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">MyScreenEffect</span><span class="p">()</span>
  <span class="k">data</span> <span class="k">class</span> <span class="nc">Exit</span><span class="p">(</span><span class="k">val</span> <span class="py">savedUserInfo</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span> <span class="n">MyScreenEffect</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>


<p>To emit effect </p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyScreenReducers</span> <span class="p">:</span> <span class="n">Reducers</span><span class="p">&lt;...,</span> <span class="n">MyScreenEffect</span><span class="p">&gt;()</span> <span class="p">{</span>

  <span class="k">fun</span> <span class="nf">onSaveUserInfoRequest</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Lce</span><span class="p">&lt;</span><span class="n">SaveUserInfoResponse</span><span class="p">&gt;)</span> <span class="p">=</span> <span class="n">reduce</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">updated</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isSaving</span> <span class="p">=</span> <span class="n">event</span><span class="p">.</span><span class="n">isLoading</span><span class="p">())</span>

    <span class="c1">// Check if there are side effects</span>
    <span class="k">val</span> <span class="py">effect</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">isData</span><span class="p">())</span> <span class="p">{</span>
      <span class="c1">// We want to close the screen when user info is saved.</span>
      <span class="n">MyScreenEffect</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">savedUserInfo</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">isError</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">MyScreenEffect</span><span class="p">.</span><span class="n">ShowErrorModal</span><span class="p">(</span><span class="n">errorMessage</span> <span class="p">=</span> <span class="n">event</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">getMessage</span><span class="p">())</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">null</span>
    <span class="p">}</span>

    <span class="n">updated</span><span class="p">.</span><span class="n">withOptionalEffect</span><span class="p">(</span><span class="n">effect</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Within the Render Formula, we can decide how to handle the effects.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyScreenRenderFormula</span> <span class="p">:</span> <span class="n">RenderFormula</span><span class="p">&lt;...,</span> <span class="p">...,</span> <span class="n">MyScreenEffect</span><span class="p">,</span> <span class="p">...&gt;</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">createRenderLoop</span><span class="p">(</span><span class="n">input</span><span class="p">:</span> <span class="p">...):</span> <span class="n">RenderLoop</span><span class="p">&lt;...,</span> <span class="n">MyScreenEffect</span><span class="p">,</span> <span class="p">...&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">RenderLoop</span><span class="p">(</span>
            <span class="p">...,</span>
            <span class="n">onEffect</span> <span class="p">=</span> <span class="p">{</span> <span class="n">effect</span> <span class="p">-&gt;</span>
                <span class="c1">// We decide here how to execute the effect. We can</span>
                <span class="c1">// 1. bubble it to the parent using the callbacks passed by the Input object</span>
                <span class="c1">// 2. handle it internally by passing it to a RxRelay or RxJava Subject</span>
                <span class="k">when</span><span class="p">(</span><span class="n">effect</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">is</span> <span class="n">ShowErrorModal</span> <span class="p">-&gt;</span> <span class="p">{</span>

                    <span class="p">}</span>
                    <span class="k">is</span> <span class="n">Exit</span> <span class="p">-&gt;</span> <span class="p">{</span>

                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="handling-user-ui-actions">Handling User UI Actions</h2>
<p>To handle user UI actions, we set listeners on Android Views and delegate to the callbacks on the Render Model. </p>
<div class="codehilite"><pre><span></span><span class="k">data</span> <span class="k">class</span> <span class="nc">MyRenderModel</span><span class="p">(</span>
  <span class="c1">// Defining a callback for a user action. </span>
  <span class="c1">// Usually, callback will not take any parameters. </span>
  <span class="k">val</span> <span class="py">onSaveButtonClicked</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">MyRenderView</span><span class="p">(...)</span> <span class="p">:</span> <span class="n">RenderView</span><span class="p">&lt;</span><span class="n">MyRenderModel</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">val</span> <span class="py">saveButton</span><span class="p">:</span> <span class="n">TextView</span> <span class="p">=</span> <span class="p">...</span>

  <span class="k">override</span> <span class="k">val</span> <span class="py">renderer</span><span class="p">:</span> <span class="n">Renderer</span><span class="p">&lt;</span><span class="n">MyRenderModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">Renderer</span><span class="p">.</span><span class="n">create</span> <span class="p">{</span> <span class="n">model</span> <span class="p">-&gt;</span>
    <span class="c1">// We just set a click listener and delegate to the callback on the Render Model.</span>
    <span class="n">saveButton</span><span class="p">.</span><span class="n">setOnClickListener</span> <span class="p">{</span>
      <span class="n">model</span><span class="p">.</span><span class="n">onSaveButtonClicked</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>  
<span class="p">}</span>
</pre></div>


<p>The Render Model creation will be scoped to the current state object, so we can use it to decide how we should bubble it up.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyRenderModelGenerator</span><span class="p">(</span>
  <span class="c1">// We splitting save button click into two options</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">showValidationError</span><span class="p">:</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">saveUserInfo</span><span class="p">:</span> <span class="p">(</span><span class="n">UserInfo</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">RenderModelGenerator</span><span class="p">&lt;</span><span class="n">State</span><span class="p">,</span> <span class="n">MyRenderModel</span><span class="p">&gt;</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">toRenderModel</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span> <span class="n">MyRenderModel</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">RenderModel</span><span class="p">(</span>
      <span class="n">onSaveButtonClicked</span> <span class="p">=</span> <span class="p">{</span>
        <span class="c1">// We use the current state to decide which callback to invoke</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">isValid</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">saveUserInfo</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">userInfo</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">showValidationError</span><span class="p">(</span><span class="s">&quot;Email field is empty.&quot;</span><span class="p">)</span>
        <span class="p">}</span>        
      <span class="p">}</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>We will provide those callbacks in the Render Formula.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyRenderFormula</span> <span class="p">:</span> <span class="n">RenderFormula</span><span class="p">&lt;</span><span class="n">Input</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="p">..,</span> <span class="n">RenderModel</span><span class="p">&gt;</span> <span class="p">{</span>

  <span class="k">class</span> <span class="nc">Input</span><span class="p">(</span>
    <span class="k">val</span> <span class="py">showToast</span><span class="p">:</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
  <span class="p">)</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">createRenderLoop</span><span class="p">(</span><span class="n">input</span><span class="p">:</span> <span class="n">Input</span><span class="p">):</span> <span class="n">RenderLoop</span><span class="p">&lt;...&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">RenderLoop</span><span class="p">(</span>
      <span class="n">renderModelGenerator</span> <span class="p">=</span> <span class="n">MyRenderModelGenerator</span><span class="p">(</span>
        <span class="c1">// There are many options here what to do with a user action. You can:</span>
        <span class="c1">// 1. Escalate it up to the parent by adding a callback to Input </span>
        <span class="c1">// 2. Delegate to another class that was injected through the constructor</span>
        <span class="c1">// 3. Handle it internally by passing the event to a PublishRelay</span>
        <span class="n">showValidationError</span> <span class="p">=</span> <span class="p">{</span> <span class="n">error</span> <span class="p">-&gt;</span>
          <span class="c1">// Let&#39;s bubble up this event to the parent of this formula using the Input class</span>
          <span class="n">input</span><span class="p">.</span><span class="n">showToast</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="n">saveUserInfo</span> <span class="p">=</span> <span class="p">{</span> <span class="n">info</span> <span class="p">-&gt;</span>

        <span class="p">}</span>
      <span class="p">)</span>
    <span class="p">)</span>
  <span class="p">}</span>  
<span class="p">}</span>
</pre></div>


<h2 id="handling-user-action-internally">Handling User Action Internally</h2>
<p>This is continuation on the above section. We want to trigger save user info request and update the UI according to request state. </p>
<div class="codehilite"><pre><span></span><span class="c1">// Let&#39;s define the repository abstraction for saving user info</span>
<span class="k">class</span> <span class="nc">SaveUserInfoRepo</span> <span class="p">{</span>
  <span class="k">fun</span> <span class="nf">saveUserInfo</span><span class="p">(</span><span class="n">info</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">):</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Lce</span><span class="p">&lt;</span><span class="n">UserInfoResponse</span><span class="p">&gt;&gt;</span>
<span class="p">}</span> 

<span class="k">class</span> <span class="nc">MyRenderFormula</span><span class="p">(</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">repo</span><span class="p">:</span> <span class="n">SaveUserInfoRepo</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">RenderFormula</span><span class="p">&lt;</span><span class="n">Input</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="p">..,</span> <span class="n">RenderModel</span><span class="p">&gt;</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">createRenderLoop</span><span class="p">(</span><span class="n">input</span><span class="p">:</span> <span class="n">Input</span><span class="p">):</span> <span class="n">RenderLoop</span><span class="p">&lt;...&gt;</span> <span class="p">{</span>
    <span class="c1">// We use a RxRelay library to turn user events into an RxJava stream. You could also use RxJava subjects.</span>
    <span class="k">val</span> <span class="py">saveUserInfoRelay</span> <span class="p">=</span> <span class="n">PublishRelay</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">UserInfo</span><span class="p">&gt;()</span>

    <span class="k">val</span> <span class="py">saveUserInfoReducer</span> <span class="p">=</span> <span class="n">saveUserInfoRelay</span>
      <span class="c1">// We use switch map to cancel previous computation.</span>
      <span class="c1">// This means if new save info action happens, we </span>
      <span class="c1">// cancel the previous request and create a new one. </span>
      <span class="p">.</span><span class="n">switchMap</span> <span class="p">{</span> <span class="n">info</span> <span class="p">-&gt;</span>
        <span class="n">repo</span><span class="p">.</span><span class="n">saveUserInfo</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">responseEvent</span> <span class="p">-&gt;</span>
        <span class="c1">// We should create a reduce a.k.a. state transformation function here.</span>
        <span class="c1">// How to accomplish that will be shown in a different example.</span>
      <span class="p">}</span>

    <span class="k">return</span> <span class="n">RenderLoop</span><span class="p">(</span>
      <span class="c1">// Since we only have a single reducer here, we pass it directly.</span>
      <span class="n">reducers</span> <span class="p">=</span> <span class="n">saveUserInfoReducer</span><span class="p">,</span>
      <span class="n">renderModelGenerator</span> <span class="p">=</span> <span class="n">MyRenderModelGenerator</span><span class="p">(</span>
        <span class="n">saveUserInfo</span> <span class="p">=</span> <span class="p">{</span> <span class="n">info</span> <span class="p">-&gt;</span>
          <span class="c1">// We pass the action to the relay</span>
          <span class="n">saveUserInfoRelay</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">)</span>
    <span class="p">)</span>
  <span class="p">}</span>  
<span class="p">}</span>
</pre></div>


<h2 id="composing-render-models">Composing Render models</h2>
<p>Render Models are meant to be composable. You can build bigger Render Models from smaller Render Models.</p>
<div class="codehilite"><pre><span></span><span class="k">data</span> <span class="k">class</span> <span class="nc">CheckboxRenderModel</span><span class="p">(</span>
  <span class="k">val</span> <span class="py">text</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
  <span class="k">val</span> <span class="py">isChecked</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
  <span class="k">val</span> <span class="py">onToggle</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
<span class="p">)</span>

<span class="k">data</span> <span class="k">class</span> <span class="nc">NotificationSettingsRenderModel</span><span class="p">(</span>
  <span class="k">val</span> <span class="py">messagePushNotification</span><span class="p">:</span> <span class="n">CheckboxRenderModel</span><span class="p">,</span>
  <span class="k">val</span> <span class="py">promotionalPushNotifications</span><span class="p">:</span> <span class="n">CheckboxRenderModel</span><span class="p">,</span>
  <span class="k">val</span> <span class="py">marketingEmailNotifications</span><span class="p">:</span> <span class="n">CheckboxRenderModel</span><span class="p">,</span>
  <span class="k">val</span> <span class="py">saveSettingsButton</span><span class="p">:</span> <span class="n">FooterButtonRenderModel</span>
<span class="p">)</span>
</pre></div>


<p>You can also do the same in your Render View layer.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CheckboxRenderView</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">root</span><span class="p">:</span> <span class="n">View</span><span class="p">)</span> <span class="p">:</span> <span class="n">RenderView</span><span class="p">&lt;</span><span class="n">CheckboxRenderModel</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">checkbox</span><span class="p">:</span> <span class="n">Checkbox</span> <span class="p">=</span> <span class="n">root</span><span class="p">.</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">checkbox</span><span class="p">)</span>

  <span class="k">override</span> <span class="k">val</span> <span class="py">renderer</span><span class="p">:</span> <span class="n">Renderer</span><span class="p">&lt;</span><span class="n">CheckboxRenderModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">Renderer</span><span class="p">.</span><span class="n">create</span> <span class="p">{</span> <span class="n">model</span> <span class="p">-&gt;</span>
    <span class="n">checkbox</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">title</span>
    <span class="n">checkbox</span><span class="p">.</span><span class="n">isChecked</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">isChecked</span>
    <span class="n">checkbox</span><span class="p">.</span><span class="n">setOnCheckedListener</span> <span class="p">{</span>
      <span class="n">model</span><span class="p">.</span><span class="n">onToggle</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span> 
<span class="p">}</span>

<span class="k">class</span> <span class="nc">NotificationSettingsRenderView</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">root</span><span class="p">:</span> <span class="n">View</span><span class="p">)</span> <span class="p">:</span> <span class="n">RenderView</span><span class="p">&lt;</span><span class="n">NotificationSettingsRenderModel</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">messagePushNotification</span> <span class="p">=</span> <span class="n">CheckboxRenderView</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">message_push_checkbox</span><span class="p">))</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">promotionalPushNotifications</span> <span class="p">=</span> <span class="n">CheckboxRenderView</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">promotional_push_checkbox</span><span class="p">))</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">marketingEmailNotifications</span> <span class="p">=</span> <span class="n">CheckboxRenderView</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">marketing_email_checkbox</span><span class="p">))</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">saveButton</span> <span class="p">=</span> <span class="n">FooterButtonRenderView</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">save_button</span><span class="p">))</span>

  <span class="k">override</span> <span class="k">val</span> <span class="py">renderer</span><span class="p">:</span> <span class="n">Renderer</span><span class="p">&lt;</span><span class="n">NotificationSettingsRenderModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">Renderer</span><span class="p">.</span><span class="n">create</span> <span class="p">{</span> <span class="n">model</span> <span class="p">-&gt;</span>
    <span class="n">messagePushNotification</span><span class="p">.</span><span class="n">renderer</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">messagePushNotification</span><span class="p">)</span>
    <span class="n">promotionalPushNotifications</span><span class="p">.</span><span class="n">renderer</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">promotionalPushNotifications</span><span class="p">)</span>
    <span class="n">marketingEmailNotifications</span><span class="p">.</span><span class="n">renderer</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">marketingEmailNotifications</span><span class="p">)</span>
    <span class="n">saveButton</span><span class="p">.</span><span class="n">renderer</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">saveSettingsButton</span><span class="p">)</span>
  <span class="p">}</span> 
<span class="p">}</span>
</pre></div>


<h2 id="annotation-processor">Annotation processor</h2>
<p>There is an optional annotation processor to remove some of the boiler plate code. It is primarily driven by
<code>@State</code> annotation placed on the State data class.</p>
<div class="codehilite"><pre><span></span><span class="n">@State</span><span class="p">(</span><span class="n">reducers</span> <span class="p">=</span> <span class="n">MyScreenReducers</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
<span class="k">data</span> <span class="k">class</span> <span class="nc">MyScreenState</span><span class="p">(</span>
  <span class="k">val</span> <span class="py">userInfoRequest</span><span class="p">:</span> <span class="n">Lce</span><span class="p">&lt;</span><span class="n">UserInfo</span><span class="p">&gt;,</span>
  <span class="k">val</span> <span class="py">isSaving</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">MyScreenReducers</span> <span class="p">:</span> <span class="n">Reducers</span><span class="p">&lt;</span><span class="n">MyScreenState</span><span class="p">,</span> <span class="n">Unit</span><span class="p">&gt;()</span> <span class="p">{</span>

  <span class="k">fun</span> <span class="nf">onUserInfoRequest</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Lce</span><span class="p">&lt;</span><span class="n">UserInfo</span><span class="p">&gt;)</span> <span class="p">=</span> <span class="n">withoutEffects</span> <span class="p">{</span> <span class="n">state</span> <span class="p">-&gt;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">userInfoRequest</span> <span class="p">=</span> <span class="n">event</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">fun</span> <span class="nf">onSaveUserInfoRequest</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Lce</span><span class="p">&lt;</span><span class="n">SaveUserInfoResponse</span><span class="p">&gt;)</span> <span class="p">=</span> <span class="n">withoutEffects</span> <span class="p">{</span> <span class="n">state</span> <span class="p">-&gt;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isSaving</span> <span class="p">=</span> <span class="n">event</span><span class="p">.</span><span class="n">isLoading</span><span class="p">())</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>This will generate an Events class that handles binding the RxJava streams to the appropriate event methods defined 
in the Reducers class.</p>
<div class="codehilite"><pre><span></span><span class="n">@Generated</span>
<span class="k">class</span> <span class="nc">MyScreenStateEvents</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">reducers</span><span class="p">:</span> <span class="n">MyScreenReducers</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">fun</span> <span class="nf">bind</span><span class="p">(</span>
    <span class="n">onUserInfoRequest</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Lce</span><span class="p">&lt;</span><span class="n">UserInfo</span><span class="p">&gt;&gt;,</span>
    <span class="n">onSaveUserInfoRequest</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Lce</span><span class="p">&lt;</span><span class="n">SaveUserInfoResponse</span><span class="p">&gt;&gt;</span>
  <span class="p">):</span> <span class="n">Observable</span><span class="p">&lt;...&gt;</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">list</span> <span class="p">=</span> <span class="n">ArrayList</span><span class="p">&lt;</span><span class="n">Observable</span><span class="p">&lt;...&gt;&gt;()</span>
    <span class="n">list</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">onUserInfoRequest</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">reducers</span><span class="o">::</span><span class="n">onUserInfoRequest</span><span class="p">))</span>
    <span class="n">list</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">onSaveUserInfoRequest</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">reducers</span><span class="o">::</span><span class="n">onSaveUserInfoRequest</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Observable</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>You can use this Events class within the Render Formula.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyScreenRenderFormula</span><span class="p">(</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">userRepo</span><span class="p">:</span> <span class="n">UserRepo</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">RenderFormula</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">,</span> <span class="n">MyScreenState</span><span class="p">,</span> <span class="n">FooterButtonRenderModel</span><span class="p">,</span> <span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">createRenderLoop</span><span class="p">(</span><span class="n">input</span><span class="p">:</span> <span class="n">Unit</span><span class="p">):</span> <span class="n">RenderLoop</span><span class="p">&lt;</span><span class="n">MyScreenState</span><span class="p">,</span> <span class="n">Unit</span><span class="p">,</span> <span class="n">FooterButtonRenderModel</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">events</span> <span class="p">=</span> <span class="n">MyScreenStateEvents</span><span class="p">(</span><span class="n">MyScreenReducers</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">RenderLoop</span><span class="p">(</span>
      <span class="p">...,</span>
      <span class="n">reducers</span> <span class="p">=</span> <span class="n">events</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span>
        <span class="n">onUserInfoRequest</span> <span class="p">=</span> <span class="n">userRepo</span><span class="p">.</span><span class="n">fetchUserInfo</span><span class="p">(),</span>
        <span class="n">onSaveUserInfoRequest</span> <span class="p">=</span> <span class="p">...</span> 
      <span class="p">)</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3 id="using-exportedproperty">Using @ExportedProperty</h3>
<p>Exported Property annotation generates a transformation that updates a single property.</p>
<div class="codehilite"><pre><span></span><span class="n">@State</span><span class="p">(</span><span class="n">reducers</span> <span class="p">=</span> <span class="n">MyScreenReducers</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
<span class="k">data</span> <span class="k">class</span> <span class="nc">MyScreenState</span><span class="p">(</span>
  <span class="n">@ExportedProperty</span> <span class="k">val</span> <span class="py">userInfoRequest</span><span class="p">:</span> <span class="n">Lce</span><span class="p">&lt;</span><span class="n">UserInfo</span><span class="p">&gt;,</span>
  <span class="p">...</span>
<span class="p">)</span>
</pre></div>


<p>The generated code is equivalent to this snippet, so we can delete it completely from MyScreenReducers.</p>
<div class="codehilite"><pre><span></span><span class="k">fun</span> <span class="nf">onUserInfoRequest</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Lce</span><span class="p">&lt;</span><span class="n">UserInfo</span><span class="p">&gt;)</span> <span class="p">=</span> <span class="n">withoutEffects</span> <span class="p">{</span> <span class="n">state</span> <span class="p">-&gt;</span>
  <span class="n">state</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">userInfoRequest</span> <span class="p">=</span> <span class="n">event</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<h3 id="using-isdirectinput-exportedproperty">Using isDirectInput (@ExportedProperty)</h3>
<p>Direct input generates a method on Events class that can directly cause a state transformation.</p>
<div class="codehilite"><pre><span></span><span class="n">@State</span>
<span class="k">data</span> <span class="k">class</span> <span class="nc">NotificationSettingsState</span><span class="p">(</span>
  <span class="n">@ExportedProperty</span><span class="p">(</span><span class="n">isDirectInput</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span> <span class="k">val</span> <span class="py">isPushNotificationsEnabled</span><span class="p">:</span> <span class="n">Boolean</span>
<span class="p">)</span>
</pre></div>


<p>Now you can update this property through the NotificationSettingsStateEvents class.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">NotificationSettingsRenderModelGenerator</span><span class="p">(</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">events</span><span class="p">:</span> <span class="n">NotificationSettingsStateEvents</span>
<span class="p">):</span> <span class="n">RenderModelGenerator</span><span class="p">&lt;</span><span class="n">NotificationSettingsState</span><span class="p">,</span> <span class="n">CheckboxRenderModel</span><span class="p">&gt;</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">toRenderModel</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">NotificationSettingsState</span><span class="p">):</span> <span class="n">CheckboxRenderModel</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">CheckboxRenderModel</span><span class="p">(</span>
      <span class="n">text</span> <span class="p">=</span> <span class="s">&quot;Push notifications&quot;</span><span class="p">,</span>
      <span class="n">isChecked</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="n">isPushNotificationsEnabled</span><span class="p">,</span>
      <span class="n">onToggle</span> <span class="p">=</span> <span class="p">{</span>
        <span class="c1">// We are invoking a generated method.</span>
        <span class="n">events</span><span class="p">.</span><span class="n">onIsPushNotificationsEnabledChanged</span><span class="p">(!</span><span class="n">state</span><span class="p">.</span><span class="n">isPushNotificationEnabled</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3 id="using-directinput">Using @DirectInput</h3>
<p>Direct Input annotation works in similar manner as <code>@ExportedProperty(isDirectInput = true)</code> except you mark
transformation methods within the Reducers class instead of properties on State class.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">TaskListReducers</span> <span class="p">:</span> <span class="n">Reducers</span><span class="p">&lt;</span><span class="n">TaskListState</span><span class="p">,</span> <span class="n">Unit</span><span class="p">&gt;()</span> <span class="p">{</span>

  <span class="n">@DirectInput</span> <span class="k">fun</span> <span class="nf">onTaskCompleted</span><span class="p">(</span><span class="n">taskId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">=</span> <span class="n">withoutEffects</span> <span class="p">{</span> <span class="n">state</span> <span class="p">-&gt;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">tasks</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">id</span> <span class="p">==</span> <span class="n">taskId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">completed</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">it</span>
      <span class="p">}</span>
    <span class="p">}</span> 
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">@State</span><span class="p">(</span><span class="n">reducers</span> <span class="p">=</span> <span class="n">TaskListReducers</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
<span class="k">data</span> <span class="k">class</span> <span class="nc">TaskListState</span><span class="p">(</span>
  <span class="k">val</span> <span class="py">tasks</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;</span>
<span class="p">)</span>
</pre></div>


<p>This will generated a method <code>TaskListStateEvents.onTaskCompleted</code>. You can now invoke this method on user input
and it will update the state.</p>
<h2 id="navigation">Navigation</h2>
<p>TODO</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>