



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Getting Started - Formula</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.0284f74d.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../css/app.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#getting-started" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Formula" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Formula
            </span>
            <span class="md-header-nav__topic">
              
                Getting Started
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/instacart/formula/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Formula
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Formula" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Formula
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/instacart/formula/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Formula
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../input/" title="Using Input" class="md-nav__link">
      Using Input
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../messages/" title="Messages" class="md-nav__link">
      Messages
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../composition/" title="Composition" class="md-nav__link">
      Composition
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../testing/" title="Testing" class="md-nav__link">
      Testing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Integration/" title="Formula Android" class="md-nav__link">
      Formula Android
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../using_android_view_model/" title="Using Android View Model" class="md-nav__link">
      Using Android View Model
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../faq/" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contributing/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#getting-started" title="Getting Started" class="md-nav__link">
    Getting Started
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-concepts" title="Core concepts" class="md-nav__link">
    Core concepts
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#state" title="State" class="md-nav__link">
    State
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#render-model" title="Render Model" class="md-nav__link">
    Render Model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#render-view" title="Render View" class="md-nav__link">
    Render View
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#formula" title="Formula" class="md-nav__link">
    Formula
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-formula" title="Using Formula" class="md-nav__link">
    Using Formula
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#listening-for-events" title="Listening for events" class="md-nav__link">
    Listening for events
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#messages" title="Messages" class="md-nav__link">
    Messages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#input" title="Input" class="md-nav__link">
    Input
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-events-to-the-parent" title="Passing events to the parent" class="md-nav__link">
    Passing events to the parent
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#composing-render-models" title="Composing Render models" class="md-nav__link">
    Composing Render models
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#composing-formulas" title="Composing formulas" class="md-nav__link">
    Composing formulas
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#diffing" title="Diffing" class="md-nav__link">
    Diffing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callbacks" title="Callbacks" class="md-nav__link">
    Callbacks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing" title="Testing" class="md-nav__link">
    Testing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faq" title="FAQ" class="md-nav__link">
    FAQ
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#threading" title="Threading" class="md-nav__link">
    Threading
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transition-already-happened" title="Transition already happened." class="md-nav__link">
    Transition already happened.
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/instacart/formula/edit/master/docs/Getting-Started.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Getting Started</h1>
                
                <h2 id="getting-started">Getting Started</h2>
<p>A functional reactive framework for managing state and side effects. It enables building 
deterministic, composable, testable applications.</p>
<h2 id="core-concepts">Core concepts</h2>
<h3 id="state">State</h3>
<p>State is a Kotlin data class that contains all the necessary information to render your view. </p>
<div class="codehilite"><pre><span></span><span class="k">data</span> <span class="k">class</span> <span class="nc">CounterState</span><span class="p">(</span><span class="k">val</span> <span class="py">count</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span>
</pre></div>


<p>Given, this is a simple state, you could also use <code>Int</code> directly.</p>
<h3 id="render-model">Render Model</h3>
<p>Render Model is an immutable representation of your view. It will be used to update the Android views. Typically,
it will also contain callbacks that will be invoked when user interacts with the UI.</p>
<div class="codehilite"><pre><span></span><span class="k">data</span> <span class="k">class</span> <span class="nc">CounterRenderModel</span><span class="p">(</span>
  <span class="k">val</span> <span class="py">title</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
  <span class="k">val</span> <span class="py">onDecrement</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
  <span class="k">val</span> <span class="py">onIncrement</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span> 
<span class="p">)</span>
</pre></div>


<h3 id="render-view">Render View</h3>
<p>Render view is responsible for taking the Render Model and applying it to the Android views.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CounterRenderView</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">root</span><span class="p">:</span> <span class="n">ViewGroup</span><span class="p">):</span> <span class="n">RenderView</span><span class="p">&lt;</span><span class="n">CounterRenderModel</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">decrementButton</span><span class="p">:</span> <span class="n">Button</span> <span class="p">=</span> <span class="n">root</span><span class="p">.</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">decrement_button</span><span class="p">)</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">incrementButton</span><span class="p">:</span> <span class="n">Button</span> <span class="p">=</span> <span class="n">root</span><span class="p">.</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">increment_button</span><span class="p">)</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">countTextView</span><span class="p">:</span> <span class="n">TextView</span> <span class="p">=</span> <span class="n">root</span><span class="p">.</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">count_text_view</span><span class="p">)</span>

    <span class="k">override</span> <span class="k">val</span> <span class="py">renderer</span><span class="p">:</span> <span class="n">Renderer</span><span class="p">&lt;</span><span class="n">CounterRenderModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">Renderer</span><span class="p">.</span><span class="n">create</span> <span class="p">{</span> <span class="n">model</span> <span class="p">-&gt;</span>
        <span class="n">countTextView</span><span class="p">.</span><span class="n">setText</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">title</span><span class="p">)</span>
        <span class="n">decrementButton</span><span class="p">.</span><span class="n">setOnClickListener</span> <span class="p">{</span>
            <span class="n">model</span><span class="p">.</span><span class="n">onDecrement</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">incrementButton</span><span class="p">.</span><span class="n">setOnClickListener</span> <span class="p">{</span>
            <span class="n">model</span><span class="p">.</span><span class="n">onIncrement</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3 id="formula">Formula</h3>
<p>Creating a counter widget that has increment/decrement buttons.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CounterFormula</span> <span class="p">:</span> <span class="n">Formula</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">,</span> <span class="n">CounterState</span><span class="p">,</span> <span class="n">CounterRenderModel</span><span class="p">&gt;</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">initialState</span><span class="p">(</span><span class="n">input</span><span class="p">:</span> <span class="n">Unit</span><span class="p">):</span> <span class="n">Int</span> <span class="p">=</span> <span class="n">CounterState</span><span class="p">(</span><span class="n">count</span> <span class="p">=</span> <span class="m">0</span><span class="p">)</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">evaluate</span><span class="p">(</span>
        <span class="n">input</span><span class="p">:</span> <span class="n">Unit</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">CounterState</span><span class="p">,</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">FormulaContext</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span>
    <span class="p">):</span> <span class="n">Evaluation</span><span class="p">&lt;</span><span class="n">CounterRenderModel</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">val</span> <span class="py">count</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="n">count</span>
        <span class="k">return</span> <span class="n">Evaluation</span><span class="p">(</span>
            <span class="n">renderModel</span> <span class="p">=</span> <span class="n">CounterRenderModel</span><span class="p">(</span>
                <span class="n">title</span> <span class="p">=</span> <span class="s">&quot;Count: $count&quot;</span><span class="p">,</span>
                <span class="n">onDecrement</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">callback</span> <span class="p">{</span>
                    <span class="n">state</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">count</span> <span class="p">=</span> <span class="n">count</span> <span class="p">-</span> <span class="m">1</span><span class="p">).</span><span class="n">noMessages</span><span class="p">()</span>
                <span class="p">},</span>
                <span class="n">onIncrement</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">callback</span> <span class="p">{</span>
                    <span class="n">state</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">count</span> <span class="p">=</span> <span class="n">count</span> <span class="p">+</span> <span class="m">1</span><span class="p">).</span><span class="n">noMessages</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3 id="using-formula">Using Formula</h3>
<p>Formula is agnostic to other layers of abstraction. It can be used within activity or a fragment. Ideally, 
it would be placed within a surface that survives configuration changes such as Android Components ViewModel.</p>
<p>In this example, I'll show how to connect Formula using Formula Android module. For using Formula with AndroidX ViewModel 
take a look at <a href="../using_android_view_model/">AndroidX Guide</a>.</p>
<p>Let's first define our Activity.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyActivity</span> <span class="p">:</span> <span class="n">FormulaAppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">lateinit</span> <span class="k">var</span> <span class="py">counterRenderView</span><span class="p">:</span> <span class="n">CounterRenderView</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">my_screen</span><span class="p">)</span>

    <span class="n">counterRenderView</span> <span class="p">=</span> <span class="n">CounterRenderView</span><span class="p">(</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">counter</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="k">fun</span> <span class="nf">render</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">CounterRenderView</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">counterRenderView</span><span class="p">.</span><span class="n">renderer</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Now, let's connect<code>MyScreenRenderFormula</code> to <code>MyActivity.render</code> function.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyApp</span> <span class="p">:</span> <span class="n">Application</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">()</span>

        <span class="n">FormulaAndroid</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">activity</span><span class="p">&lt;</span><span class="n">MyActivity</span><span class="p">&gt;</span> <span class="p">{</span>
                <span class="n">store</span><span class="p">(</span>
                    <span class="n">streams</span> <span class="p">=</span> <span class="p">{</span>
                        <span class="k">val</span> <span class="py">formula</span> <span class="p">=</span> <span class="n">CounterFormula</span><span class="p">()</span>
                        <span class="n">update</span><span class="p">(</span><span class="n">formula</span><span class="p">.</span><span class="n">state</span><span class="p">(</span><span class="n">Unit</span><span class="p">),</span> <span class="n">MyActivity</span><span class="o">::</span><span class="n">render</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>And that's it. To learn more, see our <a href="../Integration/">Formula Android Guide</a>. </p>
<h3 id="listening-for-events">Listening for events</h3>
<p>Formula uses RxJava to deal with event streams. You can either use <code>Observable</code> directly or wrap it in a <code>RxStream</code>.</p>
<p>Usually event stream dependencies will be passed/injected through the constructor.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MyFormula</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">dataObservable</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">MyData</span><span class="p">&gt;):</span> <span class="n">Formula</span><span class="p">&lt;....&gt;</span>
</pre></div>


<p>To listen to your data observable, you need to declare a binding within <code>Formula.evaluate</code> block.</p>
<div class="codehilite"><pre><span></span><span class="n">Evaluation</span><span class="p">(</span>
    <span class="n">renderModel</span> <span class="p">...,</span>
    <span class="c1">// We declare the event streams within `updates` block</span>
    <span class="n">updates</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">updates</span> <span class="p">{</span>
        <span class="n">events</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="n">dataObservable</span><span class="p">)</span> <span class="p">{</span> <span class="n">update</span><span class="p">:</span> <span class="n">MyData</span> <span class="p">-&gt;</span>
            <span class="c1">// the listener is always scoped to the current `state` so you can update it as part of the transition</span>
            <span class="n">state</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">myData</span> <span class="p">=</span> <span class="n">update</span><span class="p">).</span><span class="n">noMessages</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>


<p><em>Note:</em> we use a unique identifier <code>"data"</code> to make sure that internal diffing mechanism can distinguish between
different streams.</p>
<h3 id="messages">Messages</h3>
<p>Messages are objects used to request execution of impure code. Use messages to execute operations such as
logging, database updates, firing network requests, notifying a parent and etc.</p>
<p>For example, lets say we want to fire analytics event when user clicks a button.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">UserProfileFormula</span><span class="p">(</span>
    <span class="k">val</span> <span class="py">userAnalyticsService</span><span class="p">:</span> <span class="n">UserAnalyticsService</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">Formula</span><span class="p">&lt;...&gt;</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">evaluate</span><span class="p">(...):</span> <span class="n">Evaluation</span><span class="p">&lt;</span><span class="n">UserProfileRenderModel</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Evaluation</span><span class="p">(</span>
            <span class="n">renderModel</span> <span class="p">=</span> <span class="n">UserProfileRenderModel</span><span class="p">(</span>
                <span class="n">onSaveSelected</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">callback</span> <span class="p">{</span>
                    <span class="n">message</span><span class="p">(</span><span class="n">userAnalyticsService</span><span class="o">::</span><span class="n">trackSaveSelected</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>The main part is the declaration within the <code>context.callback</code> block.</p>
<div class="codehilite"><pre><span></span><span class="n">context</span><span class="p">.</span><span class="n">callback</span> <span class="p">{</span>
    <span class="c1">// We do a state transition and declare 0..N messages that we want to execute.</span>
<span class="p">}</span>
</pre></div>


<h3 id="input">Input</h3>
<p>Input is used to pass information/data from the parent to the child. </p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ItemDetailFormula</span><span class="p">()</span> <span class="p">:</span> <span class="n">Formula</span><span class="p">&lt;</span><span class="n">Input</span><span class="p">,</span> <span class="p">...,</span> <span class="p">...&gt;</span> <span class="p">{</span>

  <span class="k">data</span> <span class="k">class</span> <span class="nc">Input</span><span class="p">(</span><span class="k">val</span> <span class="py">itemId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">evaluate</span><span class="p">(</span>
    <span class="n">input</span><span class="p">:</span> <span class="n">Input</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="p">..,</span>
    <span class="n">context</span><span class="p">:</span> <span class="p">..</span>
  <span class="p">):</span> <span class="n">Evaluation</span><span class="p">&lt;...&gt;</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">itemId</span> <span class="p">=</span> <span class="n">input</span><span class="p">.</span><span class="n">itemId</span>
    <span class="c1">// We can use the input here to fetch the item from the repo.</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3 id="passing-events-to-the-parent">Passing events to the parent</h3>
<p>To pass events to the parent, we need to first define the callbacks on the <code>Formula.Input</code> class.</p>
<div class="codehilite"><pre><span></span><span class="k">data</span> <span class="k">class</span> <span class="nc">ItemListInput</span><span class="p">(</span>
  <span class="k">val</span> <span class="py">onItemSelected</span><span class="p">:</span> <span class="p">(</span><span class="n">itemId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
<span class="p">)</span>
</pre></div>


<p>Also, lets make sure that <code>Input</code> type is declared at the top of our <code>formula</code>.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ItemListFormula</span><span class="p">()</span> <span class="p">:</span> <span class="n">Formula</span><span class="p">&lt;</span><span class="n">ItemListInput</span><span class="p">,</span> <span class="p">...,</span> <span class="p">...&gt;</span>
</pre></div>


<p>Now, we can use the the Message API and the <code>input</code> passed to us in <code>Formula.evaluate</code> to communicate with the parent.</p>
<div class="codehilite"><pre><span></span><span class="k">override</span> <span class="k">fun</span> <span class="nf">evaluate</span><span class="p">(</span>
  <span class="n">input</span><span class="p">:</span> <span class="n">ItemListInput</span><span class="p">,</span>
  <span class="n">state</span><span class="p">:</span> <span class="p">..,</span>
  <span class="n">context</span><span class="p">:</span> <span class="p">..</span>
<span class="p">):</span> <span class="n">Evaluation</span><span class="p">&lt;...&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">Evaluation</span><span class="p">(</span>
    <span class="n">renderModel</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="n">items</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">item</span> <span class="p">-&gt;</span>
      <span class="n">context</span><span class="p">.</span><span class="n">key</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ItemRow</span><span class="p">(</span>
          <span class="n">name</span> <span class="p">=</span> <span class="n">item</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
          <span class="n">onClick</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">callback</span> <span class="p">{</span>
            <span class="c1">// sending a message to `input.onItemSelected` with parameter `item.id`</span>
            <span class="n">message</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">onItemSelected</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p><strong>Note:</strong> instead of calling <code>input.onItemSelected(item.id)</code>, we call <code>message(input.onItemSelected, item.id)</code>. This
allows formula runtime to ensure that parent is in the right state to handle the message.</p>
<h2 id="composing-render-models">Composing Render models</h2>
<p>Render Models are meant to be composable. You can build bigger Render Models from smaller Render Models.</p>
<div class="codehilite"><pre><span></span><span class="k">data</span> <span class="k">class</span> <span class="nc">CheckboxRenderModel</span><span class="p">(</span>
  <span class="k">val</span> <span class="py">text</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
  <span class="k">val</span> <span class="py">isChecked</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
  <span class="k">val</span> <span class="py">onToggle</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
<span class="p">)</span>

<span class="k">data</span> <span class="k">class</span> <span class="nc">NotificationSettingsRenderModel</span><span class="p">(</span>
  <span class="k">val</span> <span class="py">messagePushNotification</span><span class="p">:</span> <span class="n">CheckboxRenderModel</span><span class="p">,</span>
  <span class="k">val</span> <span class="py">promotionalPushNotifications</span><span class="p">:</span> <span class="n">CheckboxRenderModel</span><span class="p">,</span>
  <span class="k">val</span> <span class="py">marketingEmailNotifications</span><span class="p">:</span> <span class="n">CheckboxRenderModel</span><span class="p">,</span>
  <span class="k">val</span> <span class="py">saveSettingsButton</span><span class="p">:</span> <span class="n">FooterButtonRenderModel</span>
<span class="p">)</span>
</pre></div>


<p>You can also do the same in your Render View layer.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CheckboxRenderView</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">root</span><span class="p">:</span> <span class="n">View</span><span class="p">)</span> <span class="p">:</span> <span class="n">RenderView</span><span class="p">&lt;</span><span class="n">CheckboxRenderModel</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">checkbox</span><span class="p">:</span> <span class="n">Checkbox</span> <span class="p">=</span> <span class="n">root</span><span class="p">.</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">checkbox</span><span class="p">)</span>

  <span class="k">override</span> <span class="k">val</span> <span class="py">renderer</span><span class="p">:</span> <span class="n">Renderer</span><span class="p">&lt;</span><span class="n">CheckboxRenderModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">Renderer</span><span class="p">.</span><span class="n">create</span> <span class="p">{</span> <span class="n">model</span> <span class="p">-&gt;</span>
    <span class="n">checkbox</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">title</span>
    <span class="n">checkbox</span><span class="p">.</span><span class="n">isChecked</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">isChecked</span>
    <span class="n">checkbox</span><span class="p">.</span><span class="n">setOnCheckedListener</span> <span class="p">{</span>
      <span class="n">model</span><span class="p">.</span><span class="n">onToggle</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span> 
<span class="p">}</span>

<span class="k">class</span> <span class="nc">NotificationSettingsRenderView</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">root</span><span class="p">:</span> <span class="n">View</span><span class="p">)</span> <span class="p">:</span> <span class="n">RenderView</span><span class="p">&lt;</span><span class="n">NotificationSettingsRenderModel</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">messagePushNotification</span> <span class="p">=</span> <span class="n">CheckboxRenderView</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">message_push_checkbox</span><span class="p">))</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">promotionalPushNotifications</span> <span class="p">=</span> <span class="n">CheckboxRenderView</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">promotional_push_checkbox</span><span class="p">))</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">marketingEmailNotifications</span> <span class="p">=</span> <span class="n">CheckboxRenderView</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">marketing_email_checkbox</span><span class="p">))</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">saveButton</span> <span class="p">=</span> <span class="n">FooterButtonRenderView</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">save_button</span><span class="p">))</span>

  <span class="k">override</span> <span class="k">val</span> <span class="py">renderer</span><span class="p">:</span> <span class="n">Renderer</span><span class="p">&lt;</span><span class="n">NotificationSettingsRenderModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">Renderer</span><span class="p">.</span><span class="n">create</span> <span class="p">{</span> <span class="n">model</span> <span class="p">-&gt;</span>
    <span class="n">messagePushNotification</span><span class="p">.</span><span class="n">renderer</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">messagePushNotification</span><span class="p">)</span>
    <span class="n">promotionalPushNotifications</span><span class="p">.</span><span class="n">renderer</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">promotionalPushNotifications</span><span class="p">)</span>
    <span class="n">marketingEmailNotifications</span><span class="p">.</span><span class="n">renderer</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">marketingEmailNotifications</span><span class="p">)</span>
    <span class="n">saveButton</span><span class="p">.</span><span class="n">renderer</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">saveSettingsButton</span><span class="p">)</span>
  <span class="p">}</span> 
<span class="p">}</span>
</pre></div>


<h2 id="composing-formulas">Composing formulas</h2>
<p>You can pass other formulas through the constructor</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MainPageFormula</span><span class="p">(</span>
    <span class="k">val</span> <span class="py">headerFormula</span><span class="p">:</span> <span class="n">HeaderFormula</span><span class="p">,</span>
    <span class="k">val</span> <span class="py">listFormula</span><span class="p">:</span> <span class="n">ListFormula</span><span class="p">,</span>
    <span class="k">val</span> <span class="py">dialogFormula</span><span class="p">:</span> <span class="n">DialogFormula</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">Formula</span><span class="p">&lt;&gt;</span> 
</pre></div>


<p>Use <code>FormulaContext.child</code> within <code>Formula.evaluate</code> to hook them up.</p>
<div class="codehilite"><pre><span></span><span class="k">val</span> <span class="py">listRenderModel</span> <span class="p">=</span> <span class="n">context</span>
    <span class="p">.</span><span class="n">child</span><span class="p">(</span><span class="n">listFormula</span><span class="p">)</span>
    <span class="p">.</span><span class="n">input</span> <span class="p">{</span>
        <span class="n">ListInput</span><span class="p">(</span>
            <span class="n">items</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="n">items</span><span class="p">,</span>
            <span class="n">onItemSelected</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">eventCallback</span> <span class="p">{</span>
                <span class="c1">// you can respond to child event</span>
            <span class="p">}</span>
    <span class="p">}</span>
</pre></div>


<p>Here is a more complete example:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">MainPageFormula</span><span class="p">(</span>
    <span class="k">val</span> <span class="py">headerFormula</span><span class="p">:</span> <span class="n">HeaderFormula</span><span class="p">,</span>
    <span class="k">val</span> <span class="py">listFormula</span><span class="p">:</span> <span class="n">ListFormula</span><span class="p">,</span>
    <span class="k">val</span> <span class="py">dialogFormula</span><span class="p">:</span> <span class="n">DialogFormula</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">Formula</span><span class="p">&lt;&gt;</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">input</span><span class="p">:</span> <span class="n">Unit</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">MyState</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">FormulaContext</span><span class="p">&lt;...&gt;):</span> <span class="n">Evaluation</span><span class="p">&lt;...&gt;</span> <span class="p">{</span>
        <span class="c1">// &quot;context.child&quot; returns a RenderModel </span>
        <span class="k">val</span> <span class="py">listRenderModel</span> <span class="p">=</span> <span class="n">context</span>
            <span class="p">.</span><span class="n">child</span><span class="p">(</span><span class="n">listFormula</span><span class="p">)</span>
            <span class="p">.</span><span class="n">input</span> <span class="p">{</span> <span class="n">createListInput</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">}</span>

        <span class="k">val</span> <span class="py">headerRenderModel</span> <span class="p">=</span> <span class="n">context</span>
            <span class="p">.</span><span class="n">child</span><span class="p">(</span><span class="n">headerFormula</span><span class="p">)</span>
            <span class="p">.</span><span class="n">input</span> <span class="p">{</span> <span class="n">createHeaderInput</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">}</span>

        <span class="c1">// We can make decisions using the current `state` about </span>
        <span class="c1">// what children to show</span>
        <span class="k">val</span> <span class="py">dialog</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">showDialog</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">context</span>
                <span class="p">.</span><span class="n">child</span><span class="p">(</span><span class="n">dialogFormula</span><span class="p">)</span>
                <span class="p">.</span><span class="n">input</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">null</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">Evaluation</span><span class="p">(</span>
            <span class="n">renderModel</span> <span class="p">=</span> <span class="n">MainRenderModel</span><span class="p">(</span>
                <span class="n">header</span> <span class="p">=</span> <span class="n">headerRenderModel</span><span class="p">,</span>
                <span class="n">list</span> <span class="p">=</span> <span class="n">listRenderModel</span><span class="p">,</span>
                <span class="n">dialog</span> <span class="p">=</span> <span class="n">dialog</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3 id="diffing">Diffing</h3>
<p>Given that we recompute everything with each state change, there is an internal diffing mechanism with Formula. This
mechanism ensures that:
1. RxJava streams are only subscribed to once.
2. Children state is persisted across every processing pass.</p>
<h3 id="callbacks">Callbacks</h3>
<p>To create a UI event callback use <code>context.callback</code> or <code>context.eventCallback</code> within <code>Formula.evaluate</code> method.</p>
<div class="codehilite"><pre><span></span><span class="n">CounterRenderModel</span><span class="p">(</span>
    <span class="n">onIncrement</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">callback</span> <span class="p">{</span>
        <span class="n">transition</span><span class="p">(</span><span class="n">state</span> <span class="p">+</span> <span class="m">1</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>


<p>Callbacks retain equality across re-evaluation (such as state changes). By default, we persist the callback in a map
where each callback is identified by it's class type. In one case this is not sufficient and you need to explicitly
provide a unique <code>key</code>. This special condition is when declaring callbacks within a loop.</p>
<p>For example, if you are mapping list of items and creating a callback within the <code>map</code> function.</p>
<div class="codehilite"><pre><span></span><span class="c1">// This will not work unless your list of items never changes (removal of item or position change).</span>
<span class="n">ItemListRenderModel</span><span class="p">(</span>
    <span class="n">items</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="n">items</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">item</span> <span class="p">-&gt;</span>
        <span class="n">ItemRenderModel</span><span class="p">(</span>
            <span class="n">name</span> <span class="p">=</span> <span class="n">item</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">onSelected</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">callback</span> <span class="p">{</span>
                <span class="c1">// perform a transition</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>


<p>To fix it, you should wrap <code>ItemRenderModel</code> creation block in <code>context.key</code> where you pass it an <code>item id</code>.</p>
<div class="codehilite"><pre><span></span><span class="n">context</span><span class="p">.</span><span class="n">key</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ItemRenderModel</span><span class="p">(</span>
        <span class="n">name</span> <span class="p">=</span> <span class="n">item</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">onSelected</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">callback</span> <span class="p">{</span>
            <span class="c1">// perform a transition</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>For each unique key we have a persisted callback instance that is kept across multiple <code>Formula.evaluate</code> calls. The
instance is disabled and removed when your <code>Formula</code> is removed or if you don't create this callback in the current
<code>Formula.evaluate</code> call.</p>
<h3 id="testing">Testing</h3>
<p>To simplify testing your Formulas, you can use <code>formula-test</code> module.</p>
<div class="codehilite"><pre><span></span>testImplementation &#39;com.github.instacart:formula-test:{latest_version}&#39;
</pre></div>


<p>Testing the last render model emission</p>
<div class="codehilite"><pre><span></span><span class="k">val</span> <span class="py">subject</span> <span class="p">=</span> <span class="n">MyFormula</span><span class="p">().</span><span class="n">test</span><span class="p">().</span><span class="n">renderModel</span> <span class="p">{</span>
    <span class="n">assertThat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">name</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;my name&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>If your Formula has children, you can replace their render model output</p>
<div class="codehilite"><pre><span></span><span class="k">val</span> <span class="py">subject</span> <span class="p">=</span> <span class="n">MyFormula</span><span class="p">().</span><span class="n">test</span> <span class="p">{</span>
    <span class="c1">// Note: we are using mockito to mock ChildRenderModel, you could also manually create it.</span>
    <span class="n">child</span><span class="p">(</span><span class="n">MyChildFormula</span><span class="o">::</span><span class="k">class</span><span class="p">,</span> <span class="n">mock</span><span class="p">&lt;</span><span class="n">ChildRenderModel</span><span class="p">&gt;())</span>
<span class="p">}</span>
</pre></div>


<p>To inspect the input that was passed to the child</p>
<div class="codehilite"><pre><span></span><span class="n">subject</span><span class="p">.</span><span class="n">childInput</span><span class="p">(</span><span class="n">MyChildFormula</span><span class="o">::</span><span class="k">class</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assertThat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">property</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;property&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>You can fake child events</p>
<div class="codehilite"><pre><span></span><span class="n">subject</span><span class="p">.</span><span class="n">childInput</span><span class="p">(</span><span class="n">MyChildFormula</span><span class="o">::</span><span class="k">class</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">onEvent</span><span class="p">(</span><span class="s">&quot;fake data&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<h2 id="faq">FAQ</h2>
<h3 id="threading">Threading</h3>
<p>The state management should be initialized on the main thread and all the transitions should also happen on the main thread. You 
will get the following exception if that is not the case.</p>
<div class="codehilite"><pre><span></span>Caused by: java.lang.IllegalStateException: Only thread that created it can trigger transitions. Expected: main, Was: Network 1
</pre></div>


<h3 id="transition-already-happened">Transition already happened.</h3>
<p>After each transition, formula is re-evaluated and new event listeners are created. If you use an old listener
you will see the following exception.</p>
<div class="codehilite"><pre><span></span>Caused by: java.lang.IllegalStateException: Transition already happened. This is using old transition callback: $it.
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>